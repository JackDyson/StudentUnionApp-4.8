@{
    ViewBag.Title = "Home Page";
}

<main>
    <div class="row">
        <section class="col-md-12" aria-labelledby="gettingStartedTitle">
            <div class="card">
                <div class="card-body">
                    <div class="row sticky dt-header-row" style="background-color: var(--card-bg)">
                        <div class="col-md-4 d-flex justify-content-between mt-2 mb-2">
                            <button id="filter" class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#filterOffCanvas" aria-controls="filterOffCanvas">Filter</button>
                            <button id="add" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">Add</button>
                            <button id="edit" class="btn btn-primary">Edit</button>
                        </div>
                        <div class="col-md-4 mt-2 mb-2">
                            <input type="text" id="search" class="form-control" placeholder="Search" />
                        </div>
                        <div class="col-md-4 d-flex justify-content-between mt-2 mb-2">
                            <button id="export" class="btn btn-primary">Export</button>
                            <button id="upload" class="btn btn-primary">Upload</button>
                            <button id="sendEmail" class="btn btn-primary">Email</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <table id="test-table" class="w-100 dataTable nowrap">
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</main>

<!-- Filters -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="filterOffCanvas" aria-labelledby="offcanvasExampleLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasExampleLabel">Offcanvas</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div>
            Select the filters you would like to apply
        </div>
        <div class="row">
            <div class="col-12">
                <div id="filterContainer">

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal modal-lg fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Student <span id="studentName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row form-container">
                    <div class="col-lg-6">
                        @*<div class="form-group">
                            <label class="control-label" for="edit-clubName">Club Name</label>
                            <input class="form-control"  id="edit-clubName" type="text">
                        </div>*@
                        <div class="form-group">
                            <label class="control-label" for="edit-clubName">Club Name</label>
                            <select class="form-select" id="edit-clubName">
                                <option value="0">Select A Club</option>
                            </select>                        
                        </div>
                    </div>
                    <div class="col-lg-6">
                        @*<div class="form-group">
                            <label class="control-label" for="edit-position">Position</label>
                            <input class="form-control"  id="edit-position" type="text">
                        </div>*@
                        <div class="form-group">
                            <label class="control-label" for="edit-position">Position</label>
                            <select class="form-select" id="edit-position">
                                <option value="0">Select A Position</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="form-group">
                            <label class="control-label" for="edit-name">Name</label>
                            <input class="form-control"  id="edit-name" type="text">
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="form-group">
                            <label class="control-label" for="edit-prefName">Preferred Name</label>
                            <input class="form-control"  id="edit-prefName" type="text">
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="form-group">
                            <label class="control-label" for="edit-phoneNum">Phone Number</label>
                            <input class="form-control"  id="edit-phoneNum" type="text">
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="form-group">
                            <label class="control-label" for="edit-email">Email Address</label>
                            <input class="form-control"  id="edit-email" type="text">
                        </div>
                    </div>
                    <div class="col-xl-6">
                        <div class="d-flex align-items-center float-end">
                            <label class="form-check-label" for="edit-agreement">Agreement Signed:</label>
                            <input id="edit-agreement" type="checkbox" class="form-check" style="margin-left: 10px; margin-top: 2px;" />
                        </div>
                    </div>
                    <div class="col-xl-6">
                        <div class="d-flex align-items-center float-end">
                            <label class="form-check-label" for="edit-training">Training Complete:</label>
                            <input id="edit-training" type="checkbox" class="form-check" style="margin-left: 10px; margin-top: 2px;" />
                        </div>
                    </div>
                    <div class="col-xl-6">
                        <div class="d-flex align-items-center float-end">
                            <label class="form-check-label" for="edit-membership">Membership Purchased:</label>
                            <input id="edit-membership" type="checkbox" class="form-check" style="margin-left: 10px; margin-top: 2px;" />
                        </div>
                    </div>
                    <div class="col-xl-6">
                        <div class="d-flex align-items-center float-end">
                            <label class="form-check-label" for="edit-food">Food Certified:</label>
                            <input id="edit-food" type="checkbox" class="form-check" style="margin-left: 10px; margin-top: 2px;" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveEditModal" type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Modal -->
<div class="modal modal-lg fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModalLabel">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row form-container">
                    <div class="col-lg-6">
                        @*<div class="form-group">
                            <label class="control-label" for="clubName">Club Name</label>
                            <input class="form-control" id="clubName" type="text">
                        </div>*@
                        <div class="form-group">
                            <label class="control-label" for="clubName">Club Name</label>
                            <select class="form-select" id="clubName">
                                <option value="0">Select A Club</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        @*<div class="form-group">
                            <label class="control-label" for="position">Position</label>
                            <input class="form-control" id="position" type="text">
                        </div>*@
                        <div class="form-group" >
                            <label class="control-label" for="position">Position</label>
                            <select class="form-select" id="position">
                                <option value="0">Select A Position</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="form-group">
                            <label class="control-label" for="name">Name</label>
                            <input class="form-control" id="name" type="text">
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="form-group">
                            <label class="control-label" for="prefName">Preferred Name</label>
                            <input class="form-control" id="prefName" type="text">
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="form-group">
                            <label class="control-label" for="phoneNum">Phone Number</label>
                            <input class="form-control" id="phoneNum" type="text">
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="form-group">
                            <label class="control-label" for="email">Email Address</label>
                            <input class="form-control" id="email" type="text">
                        </div>
                    </div>
                    <div class="col-xl-6">
                        <div class="d-flex align-items-center float-end">
                            <label class="form-check-label" for="agreement">Agreement Signed:</label>
                            <input id="agreement" type="checkbox" class="form-check" style="margin-left: 10px; margin-top: 2px;" />
                        </div>
                    </div>
                    <div class="col-xl-6">
                        <div class="d-flex align-items-center float-end">
                            <label class="form-check-label" for="training">Training Complete:</label>
                            <input id="training" type="checkbox" class="form-check" style="margin-left: 10px; margin-top: 2px;" />
                        </div>
                    </div>
                    <div class="col-xl-6">
                        <div class="d-flex align-items-center float-end">
                            <label class="form-check-label" for="membership">Membership Purchased:</label>
                            <input id="membership" type="checkbox" class="form-check" style="margin-left: 10px; margin-top: 2px;" />
                        </div>
                    </div>
                    <div class="col-xl-6">
                        <div class="d-flex align-items-center float-end">
                            <label class="form-check-label" for="food">Food Certified:</label>
                            <input id="food" type="checkbox" class="form-check" style="margin-left: 10px; margin-top: 2px;" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveAddModal" type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Email Modal -->
<div class="modal modal-lg fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emailModalLabel">Email Selected Students</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row form-container">
                    
                </div>
            </div>
            <div class="modal-footer">
                <button id="sendEmail" type="button" class="btn btn-primary">Send Email</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        var societyList = [];
        var positionList = [];
        var table;
        $(document).ready(function () {
            // Get the list of societies
            $.ajax({
                url: 'Student/GetSocieties',
                type: 'GET',
                success: function (data) {
                    societyList = data;
                    societyList.forEach(function (society) {
                        $('#clubName').append(`<option value="${society.Club_Name}">${society.Club_Name}</option>`);
                        $('#edit-clubName').append(`<option value="${society.Club_Name}">${society.Club_Name}</option>`);
                    });
                    // Get the list of positions
                    $.ajax({
                        url: 'Student/GetPositions',
                        type: 'GET',
                        success: function (data) {
                            positionList = data;
                            positionList.forEach(function (position) {
                                $('#position').append(`<option value="${position.Position}">${position.Position}</option>`);
                                $('#edit-position').append(`<option value="${position.Position}">${position.Position}</option>`);
                            });
                            // add societies and positions to the filter off canvas 
                            societyList.forEach(function (society) {
                                $('#filterContainer')
                                    .append(`<div class="form-check">
                                                <input class="form-check" type="checkbox" value="${society.Club_Name}" id="${society.Club_Name}">
                                                <label class="form-check-label" for="${society.Club_Name}">${society.Club_Name}</label>
                                            </div>`);
                            });
                            positionList.forEach(function (position) {
                                $('#filterContainer')
                                    .append(`<div class="form-check">
                                                <input class="form-check" type="checkbox" value="${position.Position}" id="${position.Position}">
                                                <label class="form-check" for="${position.Position}">${position.Position}</label>
                                            </div>`);
                                    });
                        }
                    });
                }
            });

            // Initialize the DataTable
            table = $('#test-table').DataTable({ // Initialize DataTable on your table
                "ajax": {
                    "url": 'Student/GetStudents', // The URL to the server-side data
                    "dataSrc": "", // Assuming the returned data is an array at the root level
                    "type": "GET", // Method type
                    "dataType": 'json' // Data type expected from the server
                },
                "dom": 'Bt', // Add the buttons to the DOM
                "buttons": [ // Define the buttons
                    {
                        extend: 'excelHtml5', // Extend the buttons
                        text: 'Export', // Button text
                        className: 'btn btn-success', // Button class
                        title: '', // Title of the Excel file
                        exportOptions: {
                            columns: [1, 2, 4, 5, 7, 8, 9, 10, 11, 12], // Columns to export
                            format: {
                                body: function (data, row, column, node) {
                                    // Check for icons and replace with TRUE or FALSE
                                    if (data.indexOf('uis-check-circle') > -1) {
                                        return 'TRUE';
                                    } else if (data.indexOf('uis-times-circle') > -1) {
                                        return 'FALSE';
                                    }
                                    return data;
                                }
                            }
                        },
                        filename: 'HSU-Test-Data' // File name
                    }
                ],
                "serverSide": false, // Server-side processing
                "order": [[0, "asc"]], // Initial sorting column
                "paging": false, // Enable paging
                "searching": true, // Enable searching
                "columnDefs": [
                    { "title": "Club", targets: 0 },
                    { "title": "Club Name", "targets": 1 },
                    { "title": "Position", "targets": 2 },
                    { "title": "Name", "targets": 3 },
                    { "title": "Student Name", targets: 4 },
                    { "title": "Pref. Name", "targets": 5 },
                    { "title": "Contact", "targets": 6 },
                    { "title": "Phone", "targets": 7 },
                    { "title": "Email", "targets": 8 },
                    { "title": "Agreement", "targets": 9 },
                    { "title": "Training", "targets": 10 },
                    { "title": "Membership", "targets": 11 },
                    { "title": "Food", "targets": 12 },
                    { "title": "Students", "targets": 13 },
                    { "className": "text-center", "targets": [9, 10, 11, 12] },
                    { "visible": false, "targets": getColumnsToHide() }
                ],
                "columns": [ // Define columns and map them to data source properties
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            return `<label>Club: </label> <text class="float-end">${row.Club_Name}</text></br>
                                    <label>Position: </label><text class="float-end">${row.Position}</text>`;
                        },
                        width: '250px'
                    },
                    { "data": "Club_Name" },
                    { "data": "Position" },
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            return `<label>Name: </label> <text class="float-end">${row.Student_Name}</text></br>
                                    <label>Pref: </label><text class="float-end">${row.Preferred_Name}</text>`;
                        }
                    },
                    { "data": "Student_Name" },
                    { "data": "Preferred_Name" },
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            return `<label>Phone: </label><text class="float-end">${row.Phone_Number}</text></br>
                                    <label>Email: </label><text class="float-end">${row.Email_Address}</text>`;
                        }
                    },
                    { "data": "Phone_Number" },
                    { "data": "Email_Address" },
                    {
                        "data": "Agreement_Signed",
                        render: function (data) {
                            return convToIcon(data);
                        }
                    },
                    {
                        "data": "Training_Complete",
                        render: function (data) {
                            return convToIcon(data);
                        }
                    },
                    {
                        "data": "Membership_Purchased",
                        render: function (data) {
                            return convToIcon(data);
                        }
                    },
                    {
                        "data": "Food_Certified",
                        render: function (data) {
                            return convToIcon(data);
                        }
                    },
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            return `<div class="row">
                                        <div class="col-12">
                                            <div class="row">
                                                <div class="col-6">
                                                    <label>Club: </label>
                                                    <text >${row.Club_Name}</text>
                                                </div>
                                                <div class="col-6" style="text-align: end">
                                                    <label style="position: relative; bottom: 8px">Agreement: </label>
                                                    <text  style="position: relative; bottom: 5px">${convToIcon(row.Agreement_Signed)}</text>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-6">
                                                    <label>Position: </label>
                                                    <text>${row.Position}</text>
                                                </div>
                                                <div class="col-6" style="text-align: end">
                                                    <label style="position: relative; bottom: 8px">Training: </label>
                                                    <text  style="position: relative; bottom: 5px">${convToIcon(row.Training_Complete)}</text>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-6">
                                                    <label>Name: </label>
                                                    <text>${row.Student_Name}</text>
                                                </div>
                                                <div class="col-6" style="text-align: end">
                                                    <label style="position: relative; bottom: 8px">Membership: </label>
                                                    <text  style="position: relative; bottom: 5px">${convToIcon(row.Membership_Purchased)}</text>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-6">
                                                    <label>Phone: </label>
                                                    <text >${row.Phone_Number}</text>
                                                </div>
                                                <div class="col-6" style="text-align: end">
                                                    <label style="position: relative; bottom: 8px">Food: </label>
                                                    <text  style="position: relative; bottom: 5px">${convToIcon(row.Food_Certified)}</text>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-12">
                                                    <label>Email: </label>
                                                    <text>${row.Email_Address}</text>
                                                </div>
                                        </div>`
                        }
                    }
                ]
            });
        });

        $(document).on("click", "tbody tr", function (e) {
            $(e.target).closest('tr').toggleClass('clicked');
        });

        $(document).on("click", "#export", function () {
            table.button('.buttons-excel').trigger();
        });

        $(document).on("keyup change", "#search", function () {
            table.search($(this).val()).draw();
        });

        $(document).on("click", "#add", function () {
            $('#addModal').modal('show');
        });

        $(document).on("click", "#saveAddModal", function () {
            // Update the database
            $.ajax({
                url: 'Student/AddStudent',
                type: 'POST',
                data: {
                    Club_Name: $('#clubName option:selected').text(),
                    Position: $('#position option:selected').text(),
                    Student_Name: $('#name').val(),
                    Preferred_Name: $('#prefName').val(),
                    Phone_Number: $('#phoneNum').val(),
                    Email_Address: $('#email').val(),
                    Agreement_Signed: $('#agreement').is(':checked'),
                    Training_Complete: $('#training').is(':checked'),
                    Membership_Purchased: $('#membership').is(':checked'),
                    Food_Certified: $('#food').is(':checked')
                },
                success: function (data) {
                    $('#addModal').modal('hide');
                    table.ajax.reload();
                }
            });
        });

        var selectedStudents = [];
        // open the edit modal and grab a list of all selected students when the edit button is clicked
        $(document).on("click", "#edit", function () {
            selectedStudents = table.rows('.clicked').data();
            if (selectedStudents.length === 0) {
                alert('Please select a student to edit');
                return;
            }

            $('#editModal').modal('show');
            $('#studentName').text(selectedStudents[0].Student_Name);
            $('#edit-clubName').val(selectedStudents[0].Club_Name).trigger('change');
            $('#edit-position').val(selectedStudents[0].Position).trigger('change');
            $('#edit-name').val(selectedStudents[0].Student_Name);
            $('#edit-prefName').val(selectedStudents[0].Preferred_Name);
            $('#edit-phoneNum').val(selectedStudents[0].Phone_Number);
            $('#edit-email').val(selectedStudents[0].Email_Address);
            $('#edit-agreement').prop('checked', selectedStudents[0].Agreement_Signed);
            $('#edit-training').prop('checked', selectedStudents[0].Training_Complete);
            $('#edit-membership').prop('checked', selectedStudents[0].Membership_Purchased);
            $('#edit-food').prop('checked', selectedStudents[0].Food_Certified);
        });

        // When you save the changes made in the edit modal update the database and move on to the next item in the selectedStudents list
        $(document).on("click", "#saveEditModal", function () {
            $.ajax({
                url: 'Student/UpdateStudent',
                type: 'POST',
                data: {
                    Club_Name: $('#edit-clubName option:selected').text(),
                    Position: $('#edit-position option:selected').text(),
                    Student_Name: $('#edit-name').val(),
                    Preferred_Name: $('#edit-prefName').val(),
                    Phone_Number: $('#edit-phoneNum').val(),
                    Email_Address: $('#edit-email').val(),
                    Agreement_Signed: $('#edit-agreement').is(':checked'),
                    Training_Complete: $('#edit-training').is(':checked'),
                    Membership_Purchased: $('#edit-membership').is(':checked'),
                    Food_Certified: $('#edit-food').is(':checked')
                },
                success: function (data) {
                    selectedStudents.shift();
                    if (selectedStudents.length === 0) {
                        $('#editModal').modal('hide');
                        table.ajax.reload();
                    }
                    else {
                        $('#studentName').text(selectedStudents[0].Student_Name);
                        $('#edit-clubName').val(selectedStudents[0].Club_Name).trigger('change');
                        $('#edit-position').val(selectedStudents[0].Position).trigger('change');
                        $('#edit-name').val(selectedStudents[0].Student_Name);
                        $('#edit-prefName').val(selectedStudents[0].Preferred_Name);
                        $('#edit-phoneNum').val(selectedStudents[0].Phone_Number);
                        $('#edit-email').val(selectedStudents[0].Email_Address);
                        $('#edit-agreement').prop('checked', selectedStudents[0].Agreement_Signed);
                        $('#edit-training').prop('checked', selectedStudents[0].Training_Complete);
                        $('#edit-membership').prop('checked', selectedStudents[0].Membership_Purchased);
                        $('#edit-food').prop('checked', selectedStudents[0].Food_Certified);
                    }
                }
            });
        });

        function convToIcon(data) {
            return data === true ? '<i class="uis uis-check-circle"></i>' : '<i class="uis uis-times-circle"></i>';
        }

        // Returns a list of columns to hide based on the width of the screen
        function getColumnsToHide() {
            if ($(window).width() < 1200) {
                return [0,1,2,3,4,5,6,7,8,9,10,11,12];
            }
            else {
                return [1, 2, 4, 5, 7, 8, 13];
            }
        }
    </script>
}